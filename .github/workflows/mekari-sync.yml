name: Mekari Jurnal Product Sync

on:
  schedule:
    # GitHub Actions uses UTC; 17:01 UTC = 00:01 WIB (UTC+7)
    - cron: "1 17 * * *"
  workflow_dispatch:
    inputs:
      reason:
        description: Optional reason for manual sync
        required: false
        default: manual-trigger

jobs:
  trigger-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve endpoint
        id: resolve-endpoint
        env:
          SECRET_ENDPOINT: ${{ secrets.MEKARI_SYNC_ENDPOINT }}
        run: |
          DEFAULT_ENDPOINT="https://api.jurnal.id/partner/core/api/v1/products"
          ENDPOINT="${SECRET_ENDPOINT:-$DEFAULT_ENDPOINT}"

          if [ -z "$ENDPOINT" ]; then
            echo "::error::Set the MEKARI_SYNC_ENDPOINT secret or update the DEFAULT_ENDPOINT." >&2
            exit 1
          fi

          echo "endpoint=$ENDPOINT" >> "$GITHUB_OUTPUT"

      - name: Trigger Mekari sync webhook
        env:
          ENDPOINT: ${{ steps.resolve-endpoint.outputs.endpoint }}
          TOKEN: ${{ secrets.MEKARI_SYNC_TOKEN }}
          EXTRA_HEADERS: ${{ secrets.MEKARI_SYNC_HEADERS }}
          REASON: ${{ github.event.inputs.reason || github.event_name }}
        run: |
          set -euo pipefail

          CURL_ARGS=("-X" "POST" "$ENDPOINT" "-H" "Content-Type: application/json")

          if [ -n "${TOKEN:-}" ]; then
            CURL_ARGS+=("-H" "Authorization: Bearer $TOKEN")
          fi

          if [ -n "${EXTRA_HEADERS:-}" ]; then
            # EXTRA_HEADERS can contain additional header lines separated by \n
            while IFS= read -r header; do
              [ -z "$header" ] && continue
              CURL_ARGS+=("-H" "$header")
            done <<< "$EXTRA_HEADERS"
          fi

          PAYLOAD=$(jq -n --arg reason "$REASON" '{ trigger: "github-actions", reason: $reason, source: "entraverse" }')

          echo "Calling sync endpoint..."
          curl --fail --show-error --silent "${CURL_ARGS[@]}" -d "$PAYLOAD"
          echo "Sync request submitted."
