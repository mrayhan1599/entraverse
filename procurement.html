<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Entraverse Admin - Pengadaan</title>
  <link rel="icon" type="image/png" href="assets/img/logo/entraverse-logo.png">
  <link rel="stylesheet" href="assets/css/styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body data-page="procurement">
  <div class="app-shell">
    <header class="topbar">
      <div class="topbar-inner">
        <div class="topbar-left">
          <button class="menu-toggle" type="button" aria-label="Buka navigasi" aria-expanded="false" data-sidebar-toggle>
            <span></span>
            <span></span>
            <span></span>
          </button>
          <a class="topbar-brand" href="dashboard.html" aria-label="Kembali ke dashboard">
            <div class="logo">
              <img src="assets/img/logo/entraverse-logo.png" alt="Logo Entraverse" loading="lazy">
            </div>
            <div class="brand">
              <span class="brand-title">Entraverse</span>
              <span class="brand-subtitle">Admin</span>
            </div>
          </a>
        </div>
        <div class="topbar-actions">
          <div class="theme-switcher theme-switcher--inline theme-switcher--compact" data-theme-control data-theme-cycle="light, dark,system">
            <button class="theme-switcher__button" type="button" data-theme-trigger aria-label="Ganti mode tampilan">
              <span class="theme-switcher__icon" aria-hidden="true" data-theme-icon></span>
              <span class="visually-hidden" data-theme-label aria-live="polite">Auto (System)</span>
            </button>
          </div>
          <div class="auth-buttons" data-guest-actions hidden>
            <a class="btn ghost-btn auth-button auth-button--login" href="login.html" aria-label="Login">
              <span class="auth-button__icon" aria-hidden="true">üîë</span>
              <span class="auth-button__label">Login</span>
            </a>
            <a class="btn primary-btn auth-button auth-button--register" href="register.html" aria-label="Register">
              <span class="auth-button__icon" aria-hidden="true">üìù</span>
              <span class="auth-button__label">Register</span>
            </a>
          </div>
          <div class="profile-menu" data-profile-menu hidden>
            <button class="avatar-button" type="button" data-profile-toggle aria-haspopup="true" aria-expanded="false">
              <span class="avatar" data-avatar-initials>AM</span>
            </button>
            <div class="profile-dropdown" data-profile-dropdown role="menu" hidden>
              <p class="profile-greeting">Hai, <span data-profile-name>Pengguna</span></p>
              <button type="button" class="btn ghost-btn full-width" data-logout>Keluar</button>
            </div>
          </div>
        </div>
      </div>
    </header>
    <div class="app-body">
      <aside class="sidebar" data-sidebar>
        <nav class="sidebar-nav">
        <div class="nav-section">
          <p class="nav-title">E-Commerce</p>
          <a class="nav-link" href="dashboard.html">
            <span class="nav-icon" aria-hidden="true">üì¶</span>
            Produk
          </a>
          <a class="nav-link" href="categories.html">
            <span class="nav-icon" aria-hidden="true">üìÇ</span>
            Kategori
          </a>
          <a class="nav-link" href="sales.html">
            <span class="nav-icon" aria-hidden="true">üßæ</span>
            Penjualan
          </a>
          <a class="nav-link" href="purchases.html">
            <span class="nav-icon" aria-hidden="true">üõí</span>
            Pembelian
          </a>
          <a class="nav-link active" href="procurement.html">
            <span class="nav-icon" aria-hidden="true">üìã</span>
            Pengadaan
          </a>
          <a class="nav-link" href="reports.html">
            <span class="nav-icon" aria-hidden="true">üìä</span>
            Laporan
          </a>
        </div>
        <div class="nav-section">
          <p class="nav-title">Vendor</p>
          <a class="nav-link" href="shipping-vendors.html">
            <span class="nav-icon" aria-hidden="true">üöö</span>
            Vendor Pengiriman
          </a>
          <a class="nav-link" href="integrations.html">
            <span class="nav-icon" aria-hidden="true">üîå</span>
            Integrasi Aplikasi API
          </a>
        </div>
        <div class="nav-section">
          <p class="nav-title">Admin</p>
          <a class="nav-link" href="users.html">
            <span class="nav-icon" aria-hidden="true">üë•</span>
            Manajemen User
          </a>
        </div>
        </nav>
      </aside>
      <button class="sidebar-collapse-toggle" type="button" aria-label="Sembunyikan navigasi" aria-expanded="true" data-sidebar-collapse>
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="m14.5 6-5 6 5 6" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"></path>
        </svg>
      </button>
      <div class="sidebar-backdrop" data-sidebar-backdrop></div>
      <main class="main-content">
      <section class="content-header">
        <div class="title-stack">
          <div class="title-bar">
            <h1>Pengadaan</h1>
            <div class="title-actions" role="toolbar" aria-label="Aksi pengadaan">
              <button class="btn primary-btn" type="button" data-scroll-target="#procurement-form">Tambah kebutuhan</button>
            </div>
          </div>
          <p>Pantau barang yang perlu dibeli, target kedatangan, dan periode penjualan agar stok selalu siap.</p>
        </div>
      </section>

      <section class="card">
        <header class="card-header">
          <div>
            <p class="eyebrow">Ringkasan</p>
            <h2>Kebutuhan Pengadaan</h2>
            <p class="helper-text" id="procurement-subtitle">Menunggu pemuatan data dari Supabase...</p>
          </div>
        </header>
        <div class="table-wrapper">
          <table class="record-table">
            <thead>
              <tr>
                <th>Barang</th>
                <th>SKU</th>
                <th>Vendor</th>
                <th class="numeric">Kebutuhan</th>
                <th>Target Datang</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="procurement-table-body">
              <tr id="procurement-empty-state">
                <td colspan="6" class="empty-state">Memuat daftar pengadaan...</td>
              </tr>
            </tbody>
          </table>
        </div>
        <footer class="card-footer">
          <div class="table-footer">
            <div class="table-footer__meta">
              <span class="table-meta" id="procurement-meta">Menampilkan 0 kebutuhan pengadaan</span>
            </div>
          </div>
        </footer>
      </section>

      <section class="card form-card" id="procurement-form-card">
        <header class="card-header">
          <div>
            <p class="eyebrow">Input cepat</p>
            <h2>Tambah kebutuhan pengadaan</h2>
            <p class="helper-text">Catat barang yang perlu dibeli beserta target waktu kedatangan.</p>
          </div>
          <span class="status-badge status-badge--info" id="supabase-state-badge">Menghubungkan Supabase...</span>
        </header>
        <form id="procurement-form">
          <div class="form-row">
            <div class="form-group">
              <label for="item-name">Nama barang</label>
              <input type="text" id="item-name" name="itemName" placeholder="Contoh: Thermal Printer" required>
            </div>
            <div class="form-group">
              <label for="item-sku">SKU</label>
              <input type="text" id="item-sku" name="sku" placeholder="SKU-PRN-001">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="item-vendor">Vendor / pemasok</label>
              <input type="text" id="item-vendor" name="vendor" placeholder="Nama vendor">
            </div>
            <div class="form-group">
              <label for="item-quantity">Jumlah kebutuhan (pcs)</label>
              <input type="number" min="1" step="1" id="item-quantity" name="quantity" placeholder="Contoh: 20" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="item-target-date">Target kedatangan</label>
              <input type="date" id="item-target-date" name="targetDate">
              <p class="helper-text">Tanggal saat stok harus tersedia di gudang.</p>
            </div>
            <div class="form-group">
              <label for="item-priority">Prioritas</label>
              <select id="item-priority" name="priority">
                <option value="tinggi">Tinggi</option>
                <option value="sedang" selected>Sedang</option>
                <option value="rendah">Rendah</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="item-notes">Catatan</label>
              <textarea id="item-notes" name="notes" rows="3" placeholder="Tambahkan konteks seperti kebutuhan bundling, garansi, atau kode promo."></textarea>
            </div>
          </div>
          <div class="form-actions">
            <button class="btn ghost-btn" type="reset">Reset</button>
            <button class="btn primary-btn" type="submit">Simpan ke Supabase</button>
          </div>
          <p class="helper-text" id="procurement-form-status" role="status" aria-live="polite"></p>
        </form>
      </section>

      <section class="card form-card" id="sales-period-card">
        <header class="card-header">
          <div>
            <p class="eyebrow">Penjualan</p>
            <h2>Pengaturan Periode A &amp; B</h2>
            <p class="helper-text">Gunakan zona waktu <strong>WIB (UTC+7)</strong> agar jadwal promo dan stok sinkron.</p>
          </div>
        </header>
        <form id="sales-period-form">
          <div class="form-row">
            <div class="form-group">
              <label for="period-a-start">Periode A - Mulai (WIB)</label>
              <input type="datetime-local" id="period-a-start" name="periodAStart" required>
            </div>
            <div class="form-group">
              <label for="period-a-end">Periode A - Selesai (WIB)</label>
              <input type="datetime-local" id="period-a-end" name="periodAEnd" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="period-b-start">Periode B - Mulai (WIB)</label>
              <input type="datetime-local" id="period-b-start" name="periodBStart" required>
            </div>
            <div class="form-group">
              <label for="period-b-end">Periode B - Selesai (WIB)</label>
              <input type="datetime-local" id="period-b-end" name="periodBEnd" required>
            </div>
          </div>
          <div class="form-actions">
            <button class="btn primary-btn" type="submit">Simpan Periode Penjualan</button>
          </div>
          <p class="helper-text" id="sales-period-status" role="status" aria-live="polite">Data tersimpan akan ditulis ke tabel <code>sales_periods</code> di Supabase.</p>
        </form>
      </section>

      <section class="card" id="sql-editor-card">
        <header class="card-header">
          <div>
            <p class="eyebrow">SQL Editor</p>
            <h2>Skrip Supabase untuk Pengadaan &amp; Periode Penjualan</h2>
            <p class="helper-text">Jalankan skrip <code>supabase/procurement_settings.sql</code> di SQL Editor Supabase agar tabel siap dipakai.</p>
          </div>
          <a class="btn ghost-btn" href="supabase/procurement_settings.sql" download>Unduh skrip</a>
        </header>
        <div aria-label="Potongan SQL Editor">
          <pre><code>-- Buat tabel kebutuhan pengadaan
CREATE TABLE IF NOT EXISTS procurement_needs (
  id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  item_name TEXT NOT NULL,
  sku TEXT,
  vendor TEXT,
  quantity NUMERIC NOT NULL,
  unit TEXT DEFAULT 'pcs',
  target_date DATE,
  priority TEXT DEFAULT 'sedang',
  notes TEXT,
  status TEXT DEFAULT 'menunggu',
  created_at TIMESTAMPTZ DEFAULT now()
);

-- Atur periode penjualan (WIB)
CREATE TABLE IF NOT EXISTS sales_periods (
  id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  period_name TEXT NOT NULL,
  start_at TIMESTAMPTZ NOT NULL,
  end_at TIMESTAMPTZ NOT NULL,
  timezone TEXT DEFAULT 'Asia/Jakarta',
  updated_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(period_name)
);</code></pre>
        </div>
      </section>
    </main>
    </div>
  </div>
  <script>
    window.entraverseConfig = window.entraverseConfig || {};
    window.entraverseConfig.supabase = window.entraverseConfig.supabase || {
      url: 'https://wnewbuwmdrnjfjsxoybs.supabase.co',
      anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InduZXdidXdtZHJuamZqc3hveWJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNjY3ODYsImV4cCI6MjA3Njc0Mjc4Nn0.8nTueW4ogLAXbbq0Q_Z6z-a8J5n9zIOhmlWIP7pimAg'
    };
  </script>
  <script src="assets/vendor/supabase-js-2.43.4.js"></script>
  <script src="assets/js/app.js"></script>
  <script>
    const state = {
      supabaseClient: null,
      supabaseReady: false,
      loadingProcurement: false,
      procurementRows: []
    };

    const PRIORITY_TONE = {
      tinggi: 'warning',
      sedang: 'info',
      rendah: 'success'
    };

    function setSupabaseBadge(text, tone = 'info') {
      const badge = document.getElementById('supabase-state-badge');
      if (!badge) return;
      badge.textContent = text;
      badge.classList.remove('status-badge--success', 'status-badge--warning', 'status-badge--info');
      badge.classList.add(`status-badge--${tone}`);
    }

    function formatDate(value) {
      if (!value) return '-';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return '-';
      return date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    function renderProcurementTable(rows) {
      const tbody = document.getElementById('procurement-table-body');
      const subtitle = document.getElementById('procurement-subtitle');
      const meta = document.getElementById('procurement-meta');
      if (!tbody) return;

      if (!rows || rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Belum ada kebutuhan pengadaan.</td></tr>';
        if (subtitle) subtitle.textContent = 'Tambahkan kebutuhan baru atau hubungkan Supabase untuk memuat daftar otomatis.';
        if (meta) meta.textContent = 'Menampilkan 0 kebutuhan pengadaan';
        return;
      }

      tbody.innerHTML = '';
      rows.forEach((row) => {
        const tr = document.createElement('tr');
        const priorityKey = (row.priority || 'sedang').toLowerCase();
        const badgeTone = PRIORITY_TONE[priorityKey] || 'info';
        tr.innerHTML = `
          <td>${row.item_name || row.name || '-'}</td>
          <td>${row.sku || '-'}</td>
          <td>${row.vendor || '-'}</td>
          <td class="numeric">${row.quantity ?? 0} ${row.unit || 'pcs'}</td>
          <td>${formatDate(row.target_date)}</td>
          <td><span class="status-badge status-badge--${badgeTone}" title="Prioritas ${priorityKey || 'sedang'}">${row.status || 'menunggu'}</span></td>
        `;
        tbody.appendChild(tr);
      });
      if (meta) meta.textContent = `Menampilkan ${rows.length} kebutuhan pengadaan`;
    }

    function parseWibDateTime(value) {
      if (!value) return null;
      const isMatch = /^(\d{4}-\d{2}-\d{2})T(\d{2}:\d{2})$/.test(value);
      if (!isMatch) return null;
      return `${value}:00+07:00`;
    }

    async function ensureSupabase() {
      const config = window.entraverseConfig?.supabase ?? {};
      if (!config.url || !config.anonKey || !window.supabase || typeof window.supabase.createClient !== 'function') {
        setSupabaseBadge('Supabase belum siap', 'warning');
        state.supabaseReady = false;
        return null;
      }
      if (state.supabaseClient) {
        state.supabaseReady = true;
        setSupabaseBadge('Terhubung ke Supabase', 'success');
        return state.supabaseClient;
      }
      state.supabaseClient = window.supabase.createClient(config.url, config.anonKey);
      state.supabaseReady = true;
      setSupabaseBadge('Terhubung ke Supabase', 'success');
      return state.supabaseClient;
    }

    async function loadProcurementRows() {
      state.loadingProcurement = true;
      const supabase = await ensureSupabase();
      if (!supabase) {
        const subtitle = document.getElementById('procurement-subtitle');
        if (subtitle) subtitle.textContent = 'Supabase belum siap, menampilkan contoh data lokal.';
        const fallback = [
          { item_name: 'Thermal Printer', sku: 'SKU-PRN-001', vendor: 'PT Cetak Cepat', quantity: 20, unit: 'pcs', target_date: new Date().toISOString(), priority: 'tinggi', status: 'menunggu' },
          { item_name: 'Kardus 40x40', sku: 'SKU-KDS-040', vendor: 'LogiPack', quantity: 120, unit: 'pcs', target_date: null, priority: 'sedang', status: 'direncanakan' }
        ];
        renderProcurementTable(fallback);
        state.loadingProcurement = false;
        return;
      }

      const { data, error } = await supabase
        .from('procurement_needs')
        .select('*')
        .order('target_date', { ascending: true, nullsLast: true });

      if (error) {
        console.error('Gagal memuat pengadaan dari Supabase', error);
        setSupabaseBadge('Supabase error', 'warning');
        renderProcurementTable([]);
        state.loadingProcurement = false;
        return;
      }

      state.procurementRows = data || [];
      renderProcurementTable(state.procurementRows);
      const subtitle = document.getElementById('procurement-subtitle');
      if (subtitle) subtitle.textContent = 'Data ditarik langsung dari Supabase.';
      state.loadingProcurement = false;
    }

    async function handleProcurementSubmit(event) {
      event.preventDefault();
      const formStatus = document.getElementById('procurement-form-status');
      const supabase = await ensureSupabase();
      if (!supabase) {
        formStatus.textContent = 'Supabase belum dikonfigurasi. Data tidak dapat disimpan.';
        return;
      }

      const formData = new FormData(event.target);
      const payload = {
        item_name: formData.get('itemName')?.toString().trim(),
        sku: formData.get('sku')?.toString().trim() || null,
        vendor: formData.get('vendor')?.toString().trim() || null,
        quantity: Number(formData.get('quantity')) || 0,
        unit: 'pcs',
        target_date: formData.get('targetDate') || null,
        priority: formData.get('priority') || 'sedang',
        notes: formData.get('notes')?.toString().trim() || null,
        status: 'menunggu'
      };

      formStatus.textContent = 'Menyimpan ke Supabase...';
      const { error } = await supabase.from('procurement_needs').insert(payload);
      if (error) {
        console.error('Gagal menyimpan pengadaan', error);
        formStatus.textContent = 'Gagal menyimpan ke Supabase. Periksa log.';
        return;
      }

      formStatus.textContent = 'Berhasil disimpan ke Supabase.';
      event.target.reset();
      await loadProcurementRows();
    }

    async function loadSalesPeriods() {
      const supabase = await ensureSupabase();
      if (!supabase) return;
      const { data, error } = await supabase.from('sales_periods').select('*').order('period_name');
      if (error) {
        console.error('Gagal memuat periode penjualan', error);
        return;
      }
      const periodA = data?.find((row) => (row.period_name || '').toLowerCase() === 'periode a');
      const periodB = data?.find((row) => (row.period_name || '').toLowerCase() === 'periode b');
      const setValue = (id, value) => {
        if (!value) return;
        const input = document.getElementById(id);
        if (input) {
          const date = new Date(value);
          if (!Number.isNaN(date.getTime())) {
            const iso = new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            input.value = iso;
          }
        }
      };
      setValue('period-a-start', periodA?.start_at);
      setValue('period-a-end', periodA?.end_at);
      setValue('period-b-start', periodB?.start_at);
      setValue('period-b-end', periodB?.end_at);
    }

    async function handleSalesPeriodSubmit(event) {
      event.preventDefault();
      const statusEl = document.getElementById('sales-period-status');
      const supabase = await ensureSupabase();
      if (!supabase) {
        statusEl.textContent = 'Supabase belum dikonfigurasi. Tidak ada data yang disimpan.';
        return;
      }

      const form = event.target;
      const formData = new FormData(form);
      const payloads = [
        {
          period_name: 'Periode A',
          start_at: parseWibDateTime(formData.get('periodAStart')),
          end_at: parseWibDateTime(formData.get('periodAEnd')),
          timezone: 'Asia/Jakarta'
        },
        {
          period_name: 'Periode B',
          start_at: parseWibDateTime(formData.get('periodBStart')),
          end_at: parseWibDateTime(formData.get('periodBEnd')),
          timezone: 'Asia/Jakarta'
        }
      ];

      if (payloads.some((row) => !row.start_at || !row.end_at)) {
        statusEl.textContent = 'Semua periode wajib diisi dalam format tanggal & waktu.';
        return;
      }

      statusEl.textContent = 'Menyimpan periode ke Supabase...';
      const { error } = await supabase.from('sales_periods').upsert(payloads, { onConflict: 'period_name' });
      if (error) {
        console.error('Gagal menyimpan periode', error);
        statusEl.textContent = 'Gagal menyimpan periode ke Supabase. Cek log.';
        return;
      }

      statusEl.textContent = 'Periode berhasil disimpan ke Supabase (WIB).';
      await loadSalesPeriods();
    }

    function wireScrollButton() {
      document.querySelectorAll('[data-scroll-target]').forEach((button) => {
        button.addEventListener('click', () => {
          const selector = button.getAttribute('data-scroll-target');
          const target = selector ? document.querySelector(selector) : null;
          if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        });
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      wireScrollButton();
      ensureSupabase();
      loadProcurementRows();
      loadSalesPeriods();
      const procurementForm = document.getElementById('procurement-form');
      const salesPeriodForm = document.getElementById('sales-period-form');
      procurementForm?.addEventListener('submit', handleProcurementSubmit);
      salesPeriodForm?.addEventListener('submit', handleSalesPeriodSubmit);
    });
  </script>
</body>
</html>
